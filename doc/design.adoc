= iphone個別バックアップツール設計書

:author: Yano, Takayuki
:toc: left
:toc-title: 目次
:icons: font
:xrefstyle: basic
:sectnums:
:source-highlighter: highlightjs
:nofooter:

<<<

== 全体動作概要

image::out/sequence/summary/summary.svg[Static,640]

== 常駐ツール

=== 動作概要

iPhoneアプリからのコマンドを受けて対応する処理を行う

.コマンド一覧
[options="autowidth"]
|===
|認証 | 認証キーが特定ユーザーのものかどうかを判定する
|MediaDB転送開始 | MediaDBの転送準備
|MediaDB転送 | MediaDBの転送
|PhotoDB転送開始 | PhotoDBの転送準備
|PhotoDB転送 | PhotoDBの転送
|個別転送開始 | 特定ファイルの転送準備
|個別転送実データ転送 |特定ファイルの転送
|個別転送進捗問合せ | 転送状態の確認
|転送済みチェック | 必要な差分の一覧を返す
|===

=== 動作詳細

==== MediaDB転送開始
MediaDBであることを付加するだけで個別転送開始にほぼ同じ

==== MediaDB転送
個別転送実データ転送に同じ

==== PhotoDB転送開始
PhotoDBであることを付加するだけで個別転送開始にほぼ同じ

==== PhotoDB転送
個別転送実データ転送に同じ

==== 個別転送開始

事前にハッシュを求めてファイルサイズとハッシュを受信する。
前回取得したDBの日時からの差分が多き過ぎる場合はその旨を返却する。

==== 個別転送実データ転送
rawデータの受信

==== 個別転送進捗問合せ
全体に対する進捗度合いを返却する。

ファイル整合とタグ付けが完了するまでは100%を返さない

==== 転送済みチェック
先に受信したDBとローカルに保存してあるファイルとの差分を検出し、ローカルに保存していないファイルの一覧を返却する



== 転送アプリ
=== 動作概要

==== 外部設定
ユーザにオートメーション設定をしてもらう前提 +
Wifi圏内に入るとアプリが起動する。

==== サーバ接続
ツールが起動するとSSLでサーバへの接続を行う。

また、管理DBを送信する

==== ファイル転送
サーバが差分を返却し、差分を転送する。 +
転送終了時に自動削除設定がされているとファイルを削除する。


=== 動作詳細


== 支援ツール

=== 動作概要

==== ファイル一覧表示機能

UIからモデルに対して対象種別のファイル一覧を取得する。

UIはファイル一覧を表示する

==== 個別転送機能
ファイル一覧で選択されたファイルをモデルに通知する

モデルは該当ファイル(およびアルバムアート)を一時ディレクトリに転送する

モデルは転送したファイルのタグ付けとリネームを行う


=== 一括転送機能
指定種別の全ファイルをモデルに通知する

以降は個別転送機能に同じ
